!function(u){"use strict";var e=u(".cs-tab-content-wrapper"),n=loftoceanRoomiCalSyncSettings.i18nText,m={},a=864e5,h=1e3,o="YYYY-MM-DD H:mm";function v(e){return e?Base64.encode(e):""}function p(e,t,a){return void 0!==A[e]&&void 0!==A[e][t]&&A[e][t].roomID?A[e][t].roomID:a||""}function g(e,t,a,n){a?(t=n.urlBase64,void 0===A[e]?A[e]={}:n.oldURLBase64&&n.oldURLBase64!=t&&void 0!==A[e][n.oldURLBase64]&&delete A[e][n.oldURLBase64],A[e][t]=n):void 0!==A[e]&&"undefined"!=A[e][t]&&(delete A[e][t],Object.keys(A[e]).length||delete A[e])}function i(e,t){return t.diff(e)>a?n.lastSyncDatePrefix+" "+e.format(o):n.lastSyncTimePassedPrefix+" "+e.fromNow()}function d(e,t,a){e.length&&(e.data("last-sync-time",1e3*parseInt(t.unix(),10)),e.html(i(t,a)))}function l(a){var t=a.list.shift(),n=moment(),o=a.list.length;u.post(loftoceanRoomiCalSyncSettings.url,{action:loftoceanRoomiCalSyncSettings.actionSync,data:{roomID:t.room,source:t.source,time:t.time}}).always(function(){Y&&Y.length&&Y.find(".added-calendar-item[data-index="+t.itemIndex+"]").length&&d(Y.find(".added-calendar-item[data-index="+t.itemIndex+"] .added-calendar-info"),n,n),a.current++;var e=a.current===a.total?100:Math.floor(a.current/a.total*100);a.bar.css("transform","scaleX("+e/100+")"),a.counter.animate({percentage:e},{duration:700,step:function(e){e=Math.floor(e);var t=Math.max(0,a.counter.parent().width()*e/100-30);a.bar.css("transform","scaleX("+e/100+")"),a.counter.text(e+"%").css("transform","translate("+t+"px, 100%)")},complete:function(){o||(a.processingMessage.hide(),a.processedMessage.show())}}),o&&l(a)})}function c(){alert("No external Calendar found.")}var t,s,r,f,y,b,S,x,k,w,C,D,R,I,B,M,j,O,T,U,L,_,E,P,X,Y,A,N=e.filter("#loftocean-room-ical-sync-tab-calendars");N.length&&(W=N.find("input.button.action.doaction"),t=N.find(".loftocean-modal"),s=t.filter("#loftocean-sync-calendars"),r=s.find(".loading-bar-wrapper .load"),f=s.find(".processing"),y=s.find(".processed"),b=s.find(".loading-bar-wrapper .load-count"),S=t.filter("#loftocean-ical-import-calendar"),x=S.find(".loftocean-import-calendar-name"),k=S.find(".loftocean-import-calendar-url"),w=S.find(".loftocean-import-calendar-room-id"),C=S.find(".loftocean-import-calendar-index"),D=S.find(".error-message-wrapper"),R=D.find(".field-required"),I=D.find(".sync-source-existing"),B=D.find(".sync-server-error"),M=t.filter("#loftocean-ical-export-calendar"),j=M.find(".copy-link-msg"),O=wp.template("loftocean-import-calendar-item"),T=t.filter("#loftocean-delete-sync-source-item"),U=T.find(".loftocean-remove-calendar-url-base64"),L=T.find(".loftocean-remove-calendar-room-id"),_=T.find(".loftocean-remove-calendar-index"),E=T.find(".loftocean-remove-imported-booking"),Y=N.find("#the-list .column-import"),A="object"==typeof loftoceanRoomiCalSyncSettings.syncSources&&Object.keys(loftoceanRoomiCalSyncSettings.syncSources).length?loftoceanRoomiCalSyncSettings.syncSources:{},N.on("click","button.loftocean-feed-url-export",function(e){e.preventDefault(),M.find(".loftocean-room-ical-feed-url").val(loftoceanRoomiCalSyncSettings.feedBaseURL+u(this).data("room-id")),j.hide(),M.addClass("show")}).on("click",".button.action.loftocean-sync-all",function(e){e.preventDefault();var t=function(){if(Object.keys(A).length){var a={count:0,list:[]},n=Math.floor(Date.now()/1e3);return Object.keys(A).forEach(function(t){a.count+=parseInt(Object.keys(A[t]).length,10),Object.keys(A[t]).forEach(function(e){a.list.push({room:A[t][e].roomID,source:e,time:n,itemIndex:A[t][e].itemIndex})})}),a}return 0}(),e=t.count;e?(f.show(),y.hide(),r.css("transform","scaleX(0)"),b.css("transform","translate( 0px, 100%)").text("0%").prop("percentage",0),s.addClass("show"),l({bar:r,counter:b,current:0,total:e,list:t.list,processingMessage:f,processedMessage:y})):c()}),t.on("click",".modal-close",function(e){e.preventDefault(),t.removeClass("show")}).on("click",".loftocean-modal-bg-overlay",function(e){t.removeClass("show")}),T.on("click","#submit",function(e){e.preventDefault();var a=U.val(),t=L.val(),n=_.val(),o=E.is(":checked"),i="room-"+t,d=u(this),e=m[i],l=Y.filter('[data-uuid="'+e+'"]'),o={urlBase64:a,roomID:p(e,a,t),removeData:o?"on":"off"};d.attr("disabled","disabled").attr("value",d.data("update-text")),u.post(loftoceanRoomiCalSyncSettings.url,{action:loftoceanRoomiCalSyncSettings.actionRemoveSyncSource,data:o}).done(function(e,t){m[i]&&g(m[i],a,!1,{}),l.length&&l.find(".added-calendar-item[data-index="+n+"]").length&&l.find(".added-calendar-item[data-index="+n+"]").each(function(){var e=u(this);e.siblings().length||e.parent().addClass("hidden"),e.remove()}),T.removeClass("show"),E.removeAttr("checked"),U.val(""),_.val(""),L.val("")}).always(function(){d.attr("disabled",!1).attr("value",d.data("label"))})}),M.on("click",".copy-link-button .button",function(e){e.preventDefault(),M.find(".loftocean-room-ical-feed-url").focus().select(),document.execCommand("copy"),j.removeClass("hidden").show()}),S.on("click","#submit",function(e){e.preventDefault();var o=x.val(),t=k.val(),a=w.val(),i=C.val(),d=v(t),e="room-"+a,n=u(this),l=m[e],c=Y.filter('[data-uuid="'+l+'"]');if(!o||!t)return R.show(),!1;if(!i&&void 0!==A[l]&&void 0!==A[l][d])return I.show(),!1;var s=i&&c.find('.added-calendar-item[data-index="'+i+'"]').length,r=s?c.find('.added-calendar-item[data-index="'+i+'"]').data("sync-url-base64"):"",f={title:o,roomID:s?p(l,r,a):a,urlBase64:d,titleBase64:v(o),oldURLBase64:r};n.attr("disabled","disabled").attr("value",n.data("update-text")),u.post(loftoceanRoomiCalSyncSettings.url,{action:loftoceanRoomiCalSyncSettings.actionUpdateSyncSource,data:f}).done(function(e,t){var a,n=s?i:h;f.itemIndex=n,g(l,d,!0,f),c.length&&(i&&c.find('.added-calendar-item[data-index="'+i+'"]').length?((a=c.find('.added-calendar-item[data-index="'+i+'"]')).data("sync-url-base64",d).find(".edit-item").html(o),r!=d&&a.find(".added-calendar-info").data("last-sync-time","").html("")):(a=O({index:h++,list:[f]}),c.children(".added-calendars").append(a).removeClass("hidden")),S.removeClass("show"),k.val(""),x.val(""),C.val(""),w.val(""))}).error(function(){B.show()}).always(function(){n.attr("disabled",!1).attr("value",n.data("label"))})}).on("focus",'input[type="text"]',function(){D.children().hide()}),Y.on("click","button.loftocean-ical-calendar-import",function(e){e.preventDefault(),k.val(""),x.val(""),C.val(""),w.val(u(this).parent().data("room-id")),D.children().hide(),S.addClass("show"),k.focus()}).on("click",".edit-item",function(e){e.preventDefault();var t=u(this),a=t.parent().parent();a.parent().siblings(".loftocean-ical-calendar-import").trigger("click"),k.val((e=a.data("sync-url-base64"))?Base64.decode(e):""),x.val(t.html()),C.val(a.data("index"))}).on("click",".button.delete-button",function(e){e.preventDefault();var t=u(this),e=t.closest(".added-calendar-item");E.removeAttr("checked"),L.val(t.closest(".column-import").data("room-id")),_.val(e.data("index")),U.val(e.data("sync-url-base64")),T.addClass("show")}).on("click",".button.sync-button",function(e){e.preventDefault();var t=u(this),a=t.closest(".column-import").data("uuid"),e=t.closest(".added-calendar-item"),t=e.data("sync-url-base64");!function(e,t,a){a.trigger("change.status.loftocean",["status-syncing"]);var n=moment();u.post(loftoceanRoomiCalSyncSettings.url,{action:loftoceanRoomiCalSyncSettings.actionSync,data:{roomID:e,source:t,time:Math.floor(Date.now()/1e3)}}).done(function(e){void 0!==e&&"undefined"!=e.success?(a.trigger("change.status.loftocean",["status-synced"]),d(a.closest(".added-calendar-item").find(".added-calendar-name .added-calendar-info"),n,moment())):a.trigger("change.status.loftocean",["status-failed"])}).error(function(){a.trigger("change.status.loftocean",["status-failed"])})}(p(a,t),t,Y.filter('[data-uuid="'+a+'"]').find('.added-calendar-item[data-index="'+e.data("index")+'"] .added-calendar-sync-status'))}).on("change.status.loftocean",".added-calendar-sync-status",function(e,t){var a;void 0!==t&&((a=u(this)).removeClass("status-syncing status-synced status-failed"),"status-failed"==t?u("<div>",{class:"sync-status-text",text:n.syncFailed}).appendTo(a):a.find(".sync-status-text").remove(),t&&a.addClass(t))}),W.on("click",function(e){var t,a,n,o;return e.preventDefault(),"sync"!=u(this).siblings(".bulk-action-selector").val()||(t=N.find(".check-column input:checked")).length&&(a=[],e=0,n=Math.floor(Date.now()/1e3),o=[],t.each(function(){var e=u(this).closest("tr").find(".column-import"),t=e.data("uuid");e.find(".added-calendar-item").each(function(){var e=u(this).data("sync-url-base64");o.includes(t+e)||void 0===A[t]||void 0===A[t][e]||(o.push(t+e),a.push({room:A[t][e].roomID,source:e,time:n,itemIndex:u(this).data("index")}))})}),(e=a.length)?(f.show(),y.hide(),r.css("transform","scaleX(0)"),b.css("transform","translate( 0px, 100%)").text("0%").prop("percentage",0),s.addClass("show"),l({bar:r,counter:b,current:0,total:e,list:a,processingMessage:f,processedMessage:y})):c()),!1}),Y.length&&(Y.each(function(){var e=u(this);e.data("room-id")&&e.data("uuid")&&(m["room-"+e.data("room-id")]=e.data("uuid"))}),Object.keys(A).length&&(P=h,X=moment(),Object.keys(A).forEach(function(a){var e,t=Y.filter('[data-uuid="'+a+'"]');t.length&&Object.keys(A[a]).length&&(Object.keys(A[a]).forEach(function(e){var t;A[a][e].lastSyncTime&&((t=moment(1e3*parseInt(A[a][e].lastSyncTime,10))).isValid()?(A[a][e].lastSyncTimePassed=i(t,X),A[a][e].lastSyncTime=1e3*parseInt(A[a][e].lastSyncTime,10)):A[a][e].lastSyncTime=""),A[a][e].itemIndex=P++,A[a][e].urlBase64=e}),e=O({index:h,list:A[a]}),t.children(".added-calendars").append(e).removeClass("hidden"),h+=parseInt(Object.keys(A[a]).length,10))}))),setTimeout(function e(){var t;N.find(".added-calendar-info").length&&(t=moment(),N.find(".added-calendar-info").each(function(){var e=u(this);e.data("last-sync-time")&&e.html(i(moment(parseInt(e.data("last-sync-time"),10)),t))}),setTimeout(function(){e()},3e5))},3e5));var q,F,G,H,Q,V,W=e.filter("#loftocean-room-ical-sync-tab-imported-bookings");W.length&&(q=W.find(".loftocean-modal.imported-order"),F=q.find(".cs-order-preview"),G=q.find(".booking-title .order-number"),H=wp.template("loftocean-room-order-details"),W.on("click","#the-list .order-view",function(e){e.preventDefault();e=u(this).data("order-id");F.html("").addClass("loading"),G.text(e),q.addClass("show"),u.post(loftoceanRoomiCalSyncSettings.url,{action:loftoceanRoomiCalSyncSettings.actionGetImportedBookingDetail,data:{order_id:e}}).done(function(e,t){e=H(e.data.detail);F.removeClass("loading").append(e)}).error(function(){var e=H({});F.removeClass("loading").append(e)})}),q.on("click",".modal-close",function(e){e.preventDefault(),q.removeClass("show")}).on("click",".loftocean-modal-bg-overlay",function(e){e.preventDefault(),q.removeClass("show")})),(e=e.filter("#loftocean-room-ical-sync-tab-settings")).length&&(Q=e.find(".loftocean-auto-sync-interval-wrapper"),V=e.find(".auto-sync-interval-option-wrapper"),e.on("change","input[name=enable_auto_sync]",function(e){u(this).is(":checked")?Q.show():Q.hide()}).on("change","select[name=auto_sync_interval]",function(e){"loftocean_24hours"==u(this).val()?V.show():V.hide()}).on("click",".loftocean-clear-booking-records",function(e){e.preventDefault();var t=u(this);t.attr("disabled","disabled").addClass("loading"),u.post(loftoceanRoomiCalSyncSettings.url,{action:loftoceanRoomiCalSyncSettings.actionRemoveBookingsWithoutExistingSource}).always(function(){t.removeAttr("disabled").removeClass("loading")})})),u("body").on("keypress",".current-page-selector",function(e){var t=u(this);t.data("url-base")&&t.val()&&"13"==(e.keyCode||e.which)&&(window.location.href=t.data("url-base")+t.val())})}(jQuery);
